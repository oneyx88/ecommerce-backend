# -------------------------------
# ğŸ§© Stage 1: Build AWS CLI
# -------------------------------
FROM debian:bullseye-slim AS awscli
RUN apt-get update && \
    apt-get install -y curl unzip && \
    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip" && \
    unzip /tmp/awscliv2.zip -d /tmp && \
    /tmp/aws/install

# -------------------------------
# ğŸŒ Stage 2: Keycloak base image (Distroless)
# -------------------------------
FROM quay.io/keycloak/keycloak:26.0.2

USER root

# æ‹·è´ AWS CLI åˆ° Keycloak é•œåƒ
COPY --from=awscli /usr/local/bin/aws /usr/local/bin/aws
COPY --from=awscli /usr/local/aws-cli /usr/local/aws-cli

# å‡†å¤‡è¯ä¹¦ç›®å½•
RUN mkdir -p /opt/keycloak/certs && chown -R keycloak:keycloak /opt/keycloak

USER keycloak

ENTRYPOINT ["sh", "-c"]
CMD ["/opt/keycloak/bin/kc.sh start --optimized"]
